# c:ph Ecosystem

Besides simply transmitting data the c:ph platform must also support:

* tracking data usage
* offering tiered account levels
* compensating content creators

* chat
* ratings
* parental controls

These features must be provided in a way that is consistent with c:ph's core
values of security, privacy and censorship resistance.

In order to achieve the scale that c:ph requires all features must be able to
be implemented using simple key/value and log data structures where the keys
are cryptographic hashes that allow data to be naturally partitioned.

## Content Containers

Content containers consist of one `head` block that describes the content and
zero or more `meta` and `data` blocks.

The id for a container is a hash of the complete container link:

    size|block 0 id|block 1 id|key

Unlike blocks, which are not related to any one piece of content, container ids
do identify a specific piece of content, and so they are inherently vulnerable
to censorship.

Consequently it must be assumed that all functionality that uses container ids
is subject to failure and cannot be relied upon.

### Container Registration

When a container is created it can be registered to a user id.

Registration does not require verfication.

The user id registered for a container cannot be reassigned.

The user id that a container is registered to gets credit for all of the
revenue generated by the container.

The user id that a container is registered to can submit a new container that
replaces the old container (update) or mark the container as deleted.

### Container Replace (Update)

Whenever a client accesses a container it can use the container id to check if
the container has been replaced or marked as deleted.

The user id that is registered for a container can submit a new container that
replaces the original or marks it as deleted.

The replace id must contain:

    size|block 0 id|block 1 id|iv

The replacement container must be encrypted with the same key as the original
container and the new randomly generated initialization vector (iv).

The c:ph platform only stores the most recent replacement for a container and
a container may be replaced multiple times.

If a container is a replacement for another container and it is being replaced
then the container that is being replaced should have its replacement link
updated to point to original container id and then the original container id
should have its replacement link updated to point to the new container.

                ------------------->
    original --/ replacement --/ replacement
            <------------------

                ---------------------------------------->
    original --/ replacement --/ replacement --/  new replacement
            <------------------               /
         <------------------------------------

By updating replacements to point back to the original and then updating the
original to point to the new replacement the current replacement can be
resolved from any intermediary replacement with two reads and a new
replacement can be created with two writes.

### Container Delete

Containers can also be marked as deleted. Marking a container as deleted does
not actually delete any data.

It is up to clients to decide how to handle containers that are marked as
deleted.

In the normal case deleted flags will be ignored. However, marking a container
as deleted will prevent any previously created replacements from being resolved.

### Chat

The container id is used as the target for all chat messages. Chat messages are
encrypted with the random chat key that is included in the `head` block.

The c:ph chat system is content oriented. When users access a content container
they can view recent chat messages related to the container and they have
the option of "following" the chat for that container.

Every user has a global chat view where the chat messages from all of the
containers they follow are displayed in a real time feed.

Users can easily jump back and forth between the global chat view and the chat
thread for any particular content container.

Users can block messages from any other user id and/or IP address

## Users

Users in the ciph system are identified by a 128bit (32byte hex) random id.

The user id may be randomly generated or it may be derived from a username and
salt.

### Registration

Users ids can be registered by sending the desired id to an endpoint.

If the id is already registered the request will be rejected.

If the id has not been registered then a new secret key for the user id will
be generated, stored and returned.

All authorized requests made for an id must be signed using the secret key.

If clients want to provide password functionality they can encrypt the secret
key with a user provided password.

### Example username

    a42f9c71:My User Name

For a derived username the user provided part of the name is prefixed with an
8 character hex salt that is used to derive the true user id.

If users choose to share their name (in chat for instance) clients must send
both the salt:username and the derived username. Clients recieving these must
validate that the derived username matches salt:username.

Clients should detect conflicting plaintext usernames with different salts and
highlight these.

## Ratings

Any user id can submit ratings for any content id.

Content can be rated on three properties:

* technical quality (is the presentation of the content good)
* content quality (is the content itself good)
* age appropriateness (what age level is the content appropriate for)

Each rating is represented as a scale of 1-9 with 0 indicating no rating given.

After users access content clients should present them with a prompt to rate
the content.

Users ids are not stored with ratings.

A partial hash of the IP address salted with the content id is used to prevent
duplicate ratings from the same IP

## Parental Controls

Whenever a container is accessed clients should retrieve the ratings for that
content and then use the age appropriateness rating to determine what hostname
to request additional content blocks from.

By using a different hostname for unrated content and for each different level
of age appropriateness c:ph makes it possible for parents to block
inappropriate content at the network level by blocking the hostnames for
content that is not allowed.

When a user is signed into a premium account where they have verified their
identify and adulthood by making a purchase their requests will be routed to
a different hostname that is not blocked and any parental controls are enforced
at the account level instead of the network level.

For instance, with a logged in account parents can set controls and required
that a password be entered in order to view content that exceeds the set
limits.

## Tiered Accounts

c:ph has two account levels: free ad-supported access and paid ad-free premium
access.

### Free Tier

* Limited download speeds (cannot stream HD video)
* Advertising in videos

### Premium Tier

* No download speed limits
* No advertising

### Premium Tier Pricing

Premium Tier accounts pay for a fixed amount of download data. Example prices
are:

* $10 / 100GB Data
* $20 / 250GB Data
* $30 / 500GB Data
* $50 / 1000GB Data

## Compensating Content Creators

c:ph shares 50% of **all** platform revenue for containers that have
registered user ids with content creators.

Revenue share is allocated to the user ids that are registered for content
containers based on the "Last One Wins" method.

For example:

If a users accesses a content container that is registered to a user id and
then upgrades to the premium tier the user id registered for that content
container will recieve 50% of the gross amount the user paid.

If a free tier user streams a video from a container then the registered user
id for that container will recieve 50% of the gross ad revenue from ads
displayed during that stream.

## Tracking Data Usage

The c:ph platform never stores any data about what content a user has accessed.

For premium tier users c:ph does record the amount of data that a user id has
downloaded in order to track the usage of allocated data.

### Tracking IP Addresses

Limited storage and tracking of IP addresses is needed to defend the c:ph
platform against Denial of Service attacks.

All IP address tracking is done exclusively in memory and never recorded to
disk.

Only resource usage information - such as the number of blocks uploaded or the
number of API calls made - is recorded.

The content uploaded or downloaded by an IP address is never recorded.

### User IP Address Blocking

When chatting on the c:ph platform users can block messages from other users.

When a user is blocked both the user id and the IP address that was blocked is
recorded.

If a user id or IP address has recieved a high proportion of blocks from other
users this information will be indicated to clients and clients may choose
to hide these messages but should indicate to users that there are messsages
that have been auto-blocked and allow users to review these messages.